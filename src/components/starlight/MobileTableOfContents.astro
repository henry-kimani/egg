---
import TableOfContentsList from "node_modules/@astrojs/starlight/components/TableOfContents/TableOfContentsList.astro";
import { Icon } from "@astrojs/starlight/components";

const { toc } = Astro.locals.starlightRoute;
---

{
toc && (
<mobile-starlight-toc data-min-h={toc.minHeadingLevel} data-max-h={toc.maxHeadingLevel}>
  <nav aria-labelledby="starlight__on-this-page--mobile">
    <details class="starlight__mobile-toc">
      <summary id="starlight__on-this-page--mobile" class="sl-flex">
        <span class="toggle sl-flex">
          <Icon name="right-caret" class="caret" size="1rem" />
        </span>
        <span class="display-current"></span>
      </summary>
      <div class="dropdown">
        <TableOfContentsList isMobile toc={toc.items} />
      </div>
    </details>
    </nav>
</mobile-starlight-toc>
  )
}

<style></style>

<script>
import { StarlightTOC } from "node_modules/@astrojs/starlight/components/TableOfContents/starlight-toc";

class MobileStarlightTOC extends StarlightTOC {
  override set current(link: HTMLLinkElement) {
    super.current = link;
    const display = this.querySelector(".display-current") as HTMLSpanElement;
    if (display) display.textContent = link.textContent;
  }

  constructor () {
    super();
    const details = this.querySelector('details');
    if (!details) return;

    const closeToC = () => {
      details.open = false;
    }

    // Close the table of contents when ever a link is clicked.
    details.querySelectorAll('a').forEach((a) => {
      a.addEventListener("click", closeToC);
    });

    // Close the table of contents when a user clicks outside of it.
    window.addEventListener("click", (e) => {
      if (!details.contains(e.target as Node)) closeToC();
    });

    // Or when they press the escape key
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && details.open) {
        const hasFocus = details.contains(document.activeElement);
        closeToC();
        if (hasFocus) {
          const summary = details.querySelector('summary');
          if (summary) summary.focus;
        }
      }
    })
  }
}

customElements.define("mobile-starlight-toc", MobileStarlightTOC);
</script>

<style>
@layer starlight.core {
  nav {
    position: fixed;
    z-index: var(--sl-z-index-toc);
    top: calc(var(--sl-nav-height) - 1px);
    inset-inline: 0;
    border-bottom: 1px solid var(--sl-color-gray-6);
    backdrop-filter: blur(1em);
  }
  @media (min-width: 50rem) {
    nav {
      inset-inline-start: var(--sl-content-inline-start, 0);
    }
  }

  summary {
    gap: 0.5rem;
    align-items: center;
    height: var(--sl-mobile-toc-height);
    padding: 0.5rem 1rem;
    font-size: var(--sl-text-sm);
    outline-offset: var(--sl-outline-offset-inside);
  }
  summary::marker,
  summary::-webkit-details-marker {
    display: none;
  }

  .toggle {
    flex-shrink: 0;
    user-select: none;
    cursor: pointer;
  }

  .caret {
    transition: .2s;
  }

  details[open] .caret {
    transform: rotateZ(90deg);
  }

  .dropdown {
    --border-top: 1px;
    margin-top: calc(-1 * var(--border-top));
    max-height: calc(85vh - var(--sl-nav-height) - var(--sl-mobile-toc-height));
    overflow-y: auto;
    box-shadow: var(--sl-shadow-md);
    overscroll-behavior: contain;
  }
}
</style>
