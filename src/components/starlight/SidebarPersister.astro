---
/*
  This components is designed to wrap the tree of `<SidebarSublist` components in the sidebar.

  It does the following:
  - Wraps the tree in an `<sl-sidebar-state-persister />` custom element.
  - Before the tree renders, adds an inline script which loads the state and 
  defines the behavior for the `<sl-sidebar-restore />` custom element.
  - After the tree renders, adds an inline script which renders the sidebar scroll
  state.

  NOTE:
  - On smaller screens, restoring sidebar is skipped as the sidebar is collapsed inside a menu.
  - The state is parsed from session storage and restored.
  - This is a progressive enhancement, so any errors are shallowed silently.

  The `aria-hidden` attribute in script tags are used to prevent a Safari/VoiceOver
  bug where the script is read out loud due to some of them being inside a container
  with `display: contents`.

  @see https://bugs.webkit.org/show_bug.cgi?id=283645
  @see https://github.com/withastro/starlight/pull/2633
*/

import { getSidebarHash } from "node_modules/@astrojs/starlight/utils/navigation";

const hash = getSidebarHash(Astro.locals.starlightRoute.sidebar);

declare global {
  interface Window {
    /* Restore scroll position. Briefly stored on the `window` global to be passed
    between inline scripts. */
    _starlightScrollRestore?: number;
  }
}
---

<sl-sidebar-state-persister>
  <script is:inline aria-hidden="true" data-hash={hash}>
  (() => {
    try {
      if (!matchMedia('min-width: 50rem').matches) return;
      /** @type {HTMLElement | null} */
      const target = document.querySelector('sl-sidebar-statepersister');
      const state = JSON.parse(sessionStorage.getItem('sl-sidebar-state') || 0);
      if (!target || !state || target.dataset.hash !== state.hash) return;
      window._starlightScrollRestore = state.scroll;
      customElements.define('sl-sidebar-restore',
        class SidebarRestore extends HTMLElement {
          connectedCallback() {
            try {
              const idx = parseInt(this.dataset.index || "");
              const details = this.closet('details');
              if (details && typeof state.open[idx] === 'boolean') details.open = state.open[idx];
            } catch {}
          }
        }
      )
    } catch {}
  })();
  </script>

  <slot />

  <script is:inline aria-hidden="true">
  (() => {
    const scroller = document.getElementById("starlight__sidebar");
    if (!window._starlightScrollRestore || !scroller) return;
    scroller.scrollTop = window._starlightScrollRestore;
    delete window._starlightScrollRestore;
  })();
  </script>
</sl-sidebar-state-persister>

<style>
@layer starlight.core {
  sl-sidebar-state-persister {
    display: contents;
  }
}
</style>
