---
import config from "virtual:starlight/user-config";
import SiteTitle from "@astrojs/starlight/components/SiteTitle.astro";
import Search from "@astrojs/starlight/components/Search.astro";
import Dropdown from "@components/dropdown/Dropdown.astro";
import DropdownTrigger from "@components/dropdown/DropdownTrigger.astro";
import DropdownContent from "@components/dropdown/DropdownContent.astro";
import DropdownGroup from "@components/dropdown/DropdownGroup.astro";
import AstroButton from "@components/buttons/AstroButton.astro";
import ThemeSelect from "./ThemeSelect.astro";
import ModalFeedbackForm from "@components/modals/ModalFeedbackForm.astro";
import ProfileCard from "@components/user/ProfileCard";
import FocusedMode from "@components/FocusedMode.astro";
import SignInSignOut from "@components/user/SignInSignOut";

const shouldRenderSearch = 
  config.pagefind || config.components.Search !== '@astro/starlight/components/Search.astro';

---

<div class="header">
  <div class="title-wrapper sl-flex">
    <SiteTitle />
  </div>

  <div class="flex items-center gap-4">
    <div class="search print:hidden">
      {shouldRenderSearch && <Search />}
    </div>
    <Dropdown>
      <DropdownTrigger controlsId="profile-dropdown-menu">
        <AstroButton
          class="rounded-full"
          size="icon"
          variant="secondary"
        >
          <user-first-letter>
            <span class="user-first-letter text-2xl"></span>
          </user-first-letter>
        </AstroButton>
      </DropdownTrigger>
      <DropdownContent id="profile-dropdown-menu">
        {/* User Profile */}
        <DropdownGroup border>
          <ProfileCard
            client:idle
            iconSize="small"
            button={{
              buttonHref: "/dashboard/profile",
              buttonContent: "Dashboard"
            }}
            showPargraph={false}
          />
        </DropdownGroup>

        {/* Site Settings */}
        <DropdownGroup border>
          <ThemeSelect />
          <ModalFeedbackForm />
          <FocusedMode />
        </DropdownGroup>

        {/* SignIn and SignOut button */}
        <DropdownGroup border={false}>
          <SignInSignOut 
            client:visible
            icon 
            variant={"minimal"} 
            className="text-(--sl-text-black) dark:text-white justify-start" 
          />
        </DropdownGroup>
      </DropdownContent>
    </Dropdown>
  </div>
</div>

<script>
import { auth } from "@firebase/client";
import { onAuthStateChanged } from "firebase/auth";

class UserFirstLetter extends HTMLElement {
  userFirstLetter = this.querySelector(".user-first-letter") as HTMLSpanElement;

  constructor() {
    super();

    onAuthStateChanged(auth, user => {
      if (user?.displayName) {
        this.userFirstLetter.textContent = user.displayName[0];
      } else {
        this.userFirstLetter.textContent = "A";
      }
    });
  }
}
customElements.define("user-first-letter", UserFirstLetter);
</script>

<script>
class ModalFeedbackForm extends HTMLElement {
  modalFeedbackForm = this.querySelector('#feedback-form-modal') as HTMLDialogElement;
  openFeedbackFormModal = this.querySelector('#open-feedback-modal') as HTMLButtonElement;
  closeFeedbackFormModal = this.querySelector('#close-feedback-modal') as HTMLButtonElement;

  constructor() {
    super();

    this.openFeedbackFormModal?.addEventListener("click", () => this.modalFeedbackForm.showModal());
    this.closeFeedbackFormModal?.addEventListener("click", () => this.modalFeedbackForm.close());
  }
}
customElements.define("modal-feedback-form", ModalFeedbackForm);
</script>

<style>
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 100%;
}

.title-wrapper{
  overflow: clip;
  padding: 0.25rem;
  margin: -0.25rem;
  min-width: 0;
}
</style>

